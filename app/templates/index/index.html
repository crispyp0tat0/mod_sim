{% extends 'base.html' %} {% block title %}European Roulette{% endblock %} {%
block content %}
<div class="spin-result">
  <p>Original Balance: <span>{{ balance["balance"] }}</span></p>
  <p>Number: <span id="result-number">-</span></p>
  <p>Color: <span id="result-color">-</span></p>
  <p>Winnings: <span id="result-winnings">-</span></p>
  <p>Balance: <span id="result-balance">-</span></p>
  <button id="top-up">Top Up</button>
</div>
<div class="roulette-container">
  <div class="pointer"></div>
  <div class="wheel">
    <!-- Numbers will be placed around the wheel -->
    <div class="number green" style="--i: 0">0</div>
    <div class="number red" style="--i: 1">32</div>
    <div class="number black" style="--i: 2">15</div>
    <div class="number red" style="--i: 3">19</div>
    <div class="number black" style="--i: 4">4</div>
    <div class="number red" style="--i: 5">21</div>
    <div class="number black" style="--i: 6">2</div>
    <div class="number red" style="--i: 7">25</div>
    <div class="number black" style="--i: 8">17</div>
    <div class="number red" style="--i: 9">34</div>
    <div class="number black" style="--i: 10">6</div>
    <div class="number red" style="--i: 11">27</div>
    <div class="number black" style="--i: 12">13</div>
    <div class="number red" style="--i: 13">36</div>
    <div class="number black" style="--i: 14">11</div>
    <div class="number red" style="--i: 15">30</div>
    <div class="number black" style="--i: 16">8</div>
    <div class="number red" style="--i: 17">23</div>
    <div class="number black" style="--i: 18">10</div>
    <div class="number red" style="--i: 19">5</div>
    <div class="number black" style="--i: 20">24</div>
    <div class="number red" style="--i: 21">16</div>
    <div class="number black" style="--i: 22">33</div>
    <div class="number red" style="--i: 23">1</div>
    <div class="number black" style="--i: 24">20</div>
    <div class="number red" style="--i: 25">14</div>
    <div class="number black" style="--i: 26">31</div>
    <div class="number red" style="--i: 27">9</div>
    <div class="number black" style="--i: 28">22</div>
    <div class="number red" style="--i: 29">18</div>
    <div class="number black" style="--i: 30">29</div>
    <div class="number red" style="--i: 31">7</div>
    <div class="number black" style="--i: 32">28</div>
    <div class="number red" style="--i: 33">12</div>
    <div class="number black" style="--i: 34">35</div>
    <div class="number red" style="--i: 35">3</div>
    <div class="number black" style="--i: 36">26</div>
    <!-- Continue for all 37 numbers -->
  </div>
  <div class="wheel-center"><button id="spin-button">Spin</button></div>
</div>

<div class="roulette-table">
  <div class="chip-selector">
    <label for="chip-select">Select chip value:</label>
    <select id="chip-select">
      <option value="1" selected>1</option>
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    <button id="clear-bets">Clear Bets</button>
  </div>
  <!-- Main number grid -->
  <div class="number-grid">
    <!-- Zero row -->
    <div class="row">
      <button class="zero" data-type="straight" data-value="0">0</button>
    </div>

    <!-- Row 1: 1,2,3 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="1">
        3
      </button>
      <button class="split" data-type="split" data-value="[2,3]"></button>
      <button class="straight black" data-type="straight" data-value="2">
        2
      </button>
      <button class="split" data-type="split" data-value="[1,2]"></button>
      <button class="straight red" data-type="straight" data-value="3">
        1
      </button>
    </div>
    <div class="row connector-row">
      <div></div>
      <button class="splitv" data-type="split" data-value="[3,6]"></button>
      <button class="corner" data-type="corner" data-value="[2,3,5,6]"></button>
      <button class="splitv" data-type="split" data-value="[2,5]"></button>
      <button class="corner" data-type="corner" data-value="[1,2,4,5]"></button>
      <button class="splitv" data-type="split" data-value="[1,4]"></button>
      <button class="line" data-type="line" data-value="[1,2,3,4,5,6]"></button>
    </div>

    <!-- Row 2: 4,5,6 -->
    <div class="row">
      <button class="straight black" data-type="straight" data-value="4">
        6
      </button>
      <button class="split" data-type="split" data-value="[5,6]"></button>
      <button class="straight red" data-type="straight" data-value="5">
        5
      </button>
      <button class="split" data-type="split" data-value="[4,5]"></button>
      <button class="straight black" data-type="straight" data-value="6">
        4
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[6,9]"></button>
      <button class="corner" data-type="corner" data-value="[5,6,8,9]"></button>
      <button class="splitv" data-type="split" data-value="[5,8]"></button>
      <button class="corner" data-type="corner" data-value="[4,5,7,8]"></button>
      <button class="splitv" data-type="split" data-value="[4,7]"></button>
      <button class="line" data-type="line" data-value="[4,5,6,7,8,9]"></button>
    </div>

    <!-- Row 3: 7,8,9 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="7">
        9
      </button>
      <button class="split" data-type="split" data-value="[8,9]"></button>
      <button class="straight black" data-type="straight" data-value="8">
        8
      </button>
      <button class="split" data-type="split" data-value="[7,8]"></button>
      <button class="straight red" data-type="straight" data-value="9">
        7
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[9,12]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[8,9,11,12]"
      ></button>
      <button class="splitv" data-type="split" data-value="[8,11]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[7,8,10,11]"
      ></button>
      <button class="splitv" data-type="split" data-value="[7,10]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[7,8,9,10,11,12]"
      ></button>
    </div>

    <!-- Row 4: 10,11,12 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="10">
        12
      </button>
      <button class="split" data-type="split" data-value="[11,12]"></button>
      <button class="straight black" data-type="straight" data-value="11">
        11
      </button>
      <button class="split" data-type="split" data-value="[10,11]"></button>
      <button class="straight black" data-type="straight" data-value="12">
        10
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[12,15]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[11,12,14,15]"
      ></button>
      <button class="splitv" data-type="split" data-value="[11,14]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[10,11,13,14]"
      ></button>
      <button class="splitv" data-type="split" data-value="[10,13]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[10,11,12,13,14,15]"
      ></button>
    </div>

    <!-- Row 5: 13,14,15 -->
    <div class="row">
      <button class="straight black" data-type="straight" data-value="13">
        15
      </button>
      <button class="split" data-type="split" data-value="[14,15]"></button>
      <button class="straight red" data-type="straight" data-value="14">
        14
      </button>
      <button class="split" data-type="split" data-value="[13,14]"></button>
      <button class="straight black" data-type="straight" data-value="15">
        13
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[15,18]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[14,15,17,18]"
      ></button>
      <button class="splitv" data-type="split" data-value="[14,17]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[13,14,16,17]"
      ></button>
      <button class="splitv" data-type="split" data-value="[13,16]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[13,14,15,16,17,18]"
      ></button>
    </div>

    <!-- Row 6: 16,17,18 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="16">
        18
      </button>
      <button class="split" data-type="split" data-value="[17,18]"></button>
      <button class="straight black" data-type="straight" data-value="17">
        17
      </button>
      <button class="split" data-type="split" data-value="[16,17]"></button>
      <button class="straight red" data-type="straight" data-value="18">
        16
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[18,21]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[17,18,20,21]"
      ></button>
      <button class="splitv" data-type="split" data-value="[17,20]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[16,17,19,20]"
      ></button>
      <button class="splitv" data-type="split" data-value="[16,19]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[16,17,18,19,20,21]"
      ></button>
    </div>

    <!-- Row 7: 19,20,21 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="19">
        21
      </button>
      <button class="split" data-type="split" data-value="[20,21]"></button>
      <button class="straight black" data-type="straight" data-value="20">
        20
      </button>
      <button class="split" data-type="split" data-value="[19,20]"></button>
      <button class="straight red" data-type="straight" data-value="21">
        19
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[21,24]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[20,21,23,24]"
      ></button>
      <button class="splitv" data-type="split" data-value="[20,23]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[19,20,22,23]"
      ></button>
      <button class="splitv" data-type="split" data-value="[19,22]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[19,20,21,22,23,24]"
      ></button>
    </div>

    <!-- Row 8: 22,23,24 -->
    <div class="row">
      <button class="straight black" data-type="straight" data-value="22">
        24
      </button>
      <button class="split" data-type="split" data-value="[23,24]"></button>
      <button class="straight red" data-type="straight" data-value="23">
        23
      </button>
      <button class="split" data-type="split" data-value="[22,23]"></button>
      <button class="straight black" data-type="straight" data-value="24">
        22
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[24,27]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[23,24,26,27]"
      ></button>
      <button class="splitv" data-type="split" data-value="[23,26]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[22,23,25,26]"
      ></button>
      <button class="splitv" data-type="split" data-value="[22,25]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[22,23,24,25,26,27]"
      ></button>
    </div>

    <!-- Row 9: 25,26,27 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="25">
        27
      </button>
      <button class="split" data-type="split" data-value="[26,27]"></button>
      <button class="straight black" data-type="straight" data-value="26">
        26
      </button>
      <button class="split" data-type="split" data-value="[25,26]"></button>
      <button class="straight red" data-type="straight" data-value="27">
        25
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[27,30]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[26,27,29,30]"
      ></button>
      <button class="splitv" data-type="split" data-value="[26,29]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[25,26,28,29]"
      ></button>
      <button class="splitv" data-type="split" data-value="[25,28]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[25,26,27,28,29,30]"
      ></button>
    </div>

    <!-- Row 10: 28,29,30 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="28">
        30
      </button>
      <button class="split" data-type="split" data-value="[29,30]"></button>
      <button class="straight black" data-type="straight" data-value="29">
        29
      </button>
      <button class="split" data-type="split" data-value="[28,29]"></button>
      <button class="straight black" data-type="straight" data-value="30">
        28
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[30,33]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[29,30,32,33]"
      ></button>
      <button class="splitv" data-type="split" data-value="[29,32]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[28,29,31,32]"
      ></button>
      <button class="splitv" data-type="split" data-value="[28,31]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[28,29,30,31,32,33]"
      ></button>
    </div>

    <!-- Row 11: 31,32,33 -->
    <div class="row">
      <button class="straight black" data-type="straight" data-value="31">
        33
      </button>
      <button class="split" data-type="split" data-value="[32,33]"></button>
      <button class="straight red" data-type="straight" data-value="32">
        32
      </button>
      <button class="split" data-type="split" data-value="[31,32]"></button>
      <button class="straight black" data-type="straight" data-value="33">
        31
      </button>
    </div>
    <div class="row connector-row">
      <button class="splitv" data-type="split" data-value="[33,36]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[32,33,35,36]"
      ></button>
      <button class="splitv" data-type="split" data-value="[32,35]"></button>
      <button
        class="corner"
        data-type="corner"
        data-value="[31,32,34,35]"
      ></button>
      <button class="splitv" data-type="split" data-value="[31,34]"></button>
      <button
        class="line"
        data-type="line"
        data-value="[31,32,33,34,35,36]"
      ></button>
    </div>

    <!-- Row 12: 34,35,36 -->
    <div class="row">
      <button class="straight red" data-type="straight" data-value="34">
        36
      </button>
      <button class="split" data-type="split" data-value="[35,36]"></button>
      <button class="straight black" data-type="straight" data-value="35">
        35
      </button>
      <button class="split" data-type="split" data-value="[34,35]"></button>
      <button class="straight red" data-type="straight" data-value="36">
        34
      </button>
    </div>
  </div>

  <div class="outside-bet">
    <!-- Dozens -->
    <div class="column dozens">
      <button
        class="dozen"
        data-type="dozen"
        data-value="[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]"
      >
        1st 12
      </button>
      <button
        class="dozen"
        data-type="dozen"
        data-value="[13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]"
      >
        2nd 12
      </button>
      <button
        class="dozen"
        data-type="dozen"
        data-value="[25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36]"
      >
        3rd 12
      </button>
    </div>

    <!-- Outside bets: 1-18, Even, Red, Black, Odd, 19-36 -->
    <div class="column outside-bets">
      <button class="low" data-type="range" data-value="1-18">1-18</button>
      <button class="even" data-type="parity" data-value="even">Even</button>
      <button class="red" data-type="color" data-value="red">Red</button>
      <button class="black" data-type="color" data-value="black">Black</button>
      <button class="odd" data-type="parity" data-value="odd">Odd</button>
      <button class="high" data-type="range" data-value="19-36">19-36</button>
    </div>
  </div>
</div>

<script>
  const bets = [];

  document.getElementById("clear-bets").addEventListener("click", () => {
    bets.length = 0;
    betButtons.forEach((button) => button.classList.remove("active-bet"));
  });

  const chipSelect = document.getElementById("chip-select");
  const betButtons = document.querySelectorAll(
    ".number-grid button, .outside-bets button, .dozen"
  );

  // Helper to parse data-value
  function parseChoices(value) {
    try {
      const parsed = JSON.parse(value);
      // Ensure it's always an array
      return Array.isArray(parsed) ? parsed : [parsed];
    } catch {
      // If parsing fails, treat as single number or string
      return [value];
    }
  }

  // Add click listeners to all bet buttons
  betButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const betType = button.dataset.type;
      const choices = parseChoices(button.dataset.value);
      const amount = parseInt(chipSelect.value, 10);

      // Add or update bet if already exists
      const existingIndex = bets.findIndex(
        (b) =>
          b.bet_type === betType &&
          JSON.stringify(b.choices) === JSON.stringify(choices)
      );

      if (existingIndex > -1) {
        bets[existingIndex].amount += amount; // Add chip value to existing bet
      } else {
        bets.push({ bet_type: betType, choices, amount });
      }

      button.classList.add("active-bet");

      console.log("Current bets:", bets);
    });
  });

  // Spin button
  document.getElementById("spin-button").addEventListener("click", function () {
    if (bets.length === 0) {
      alert("Place at least one bet!");
      return;
    }

    fetch("/api/spin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ bets }),
    })
      .then((r) => r.json())
      .then((data) => {
        const wheelOrder = [
          0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10,
          5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26,
        ];

        const wheel = document.querySelector(".wheel");
        const index = wheelOrder.indexOf(data.number);
        const slice = 360 / wheelOrder.length;
        const finalAngle = index * slice * -1 + 360 * 5;

        wheel.style.transition = "none";
        wheel.style.transform = "rotate(0deg)";
        void wheel.offsetWidth; // force reset
        wheel.style.transition = "transform 3.5s ease-out";
        wheel.style.transform = `rotate(${finalAngle}deg)`;

        document.getElementById("result-number").textContent = data.number;
        document.getElementById("result-color").textContent = data.color;
        document.getElementById("result-winnings").textContent = data.winnings;
        document.getElementById("result-balance").textContent = data.balance;
      });
  });

  document.getElementById("top-up").addEventListener("click", () => {
    const topUpAmount = 1000; // or prompt the user for an amount

    fetch("/api/topup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ amount: topUpAmount }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          document.getElementById("result-balance").textContent = data.balance;
          console.log(`Balance topped up to ${data.balance}`);
        } else {
          alert("Top up failed: " + data.message);
        }
      })
      .catch((err) => {
      });
  });
</script>

{% endblock %}
